{% extends "butterflies/base.html" %}
{% load i18n %}
{% load static %}
{% load butterfly_extras butterfly_display query_utils %}
{% block title %}{% blocktrans %}Edit {{ model_name }} Table{% endblocktrans %}{% endblock %}
{% block header %}<img src="{% static 'butterflies/img/logo_ASA_curvas.jpg' %}" alt="ASA Logo" class="header-logo" style="height: 50px;">{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'butterflies/css/utilities.css' %}">
<link rel="stylesheet" href="{% static 'butterflies/css/pagination.css' %}">
{% if supports_grid_view %}
<link rel="stylesheet" href="{% static 'butterflies/css/grid-view.css' %}">
{% endif %}
<div class="d-flex align-items-center mb-3">
  <h2 class="mb-0">{% blocktrans %}Edit {{ model_name }} Table{% endblocktrans %}</h2>
  <div class="ml-3 text-muted" style="max-width: 400px;">
    <p class="m-0">{% trans "Enter specimen catalog number or range and add additional filters (optional)." %}</p>
  </div>
</div>

<div class="mb-3">
  <a href="{% url 'export_model_csv' model_name_internal %}" class="mr-2">{% trans "Export CSV" %}</a>
  <a href="{% url 'export_model_excel' model_name_internal %}" class="mr-2">{% trans "Export Excel" %}</a>
  {% load auth_tags %}
  {% if user.is_superuser or user|has_group:'Admin' %}
    {% if model_name_internal == 'specimen' %}
      {% with bulk_delete_confirm_msg=_("This is a debug feature. Are you sure you want to proceed to the bulk delete page?") %}
        <a href="{% url 'debug_bulk_delete_specimen' %}" class="text-danger"
           onclick="return confirm('{{ bulk_delete_confirm_msg }}')">
          {% trans "Debug Bulk Delete" %}
        </a>
        <span class="mx-2">|</span>
        {% with bulk_delete_filtered_msg=_("This is a debug feature. Proceed to delete all currently filtered specimens?") %}
          <a href="{% url 'debug_bulk_delete_specimen_filtered' %}?{{ request.META.QUERY_STRING }}" class="text-danger"
             onclick="return confirm('{{ bulk_delete_filtered_msg }}')">
            {% trans "Debug Bulk Delete Filtered" %}
          </a>
        {% endwith %}
      {% endwith %}
    {% endif %}
  {% endif %}
</div>

{% if supports_grid_view %}
<div class="view-toggle">
  <span class="text-muted">{% trans "View:" %}</span>
  <form method="post" class="view-toggle-form" style="display: inline-flex; align-items: center; gap: 5px;">
    {% csrf_token %}
    <input type="hidden" name="toggle_view_mode" value="1">
    <button type="submit" name="view_mode" value="table" 
            class="view-toggle-button {% if view_mode == 'table' %}active{% endif %}">
      <svg class="view-toggle-icon" viewBox="0 0 24 24">
        <path d="M3 3h18v4H3V3zm0 6h18v4H3V9zm0 6h18v4H3v-4z"/>
      </svg>
      {% trans "Table" %}
    </button>
    <button type="submit" name="view_mode" value="grid" 
            class="view-toggle-button {% if view_mode == 'grid' %}active{% endif %}">
      <svg class="view-toggle-icon" viewBox="0 0 24 24">
        <path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/>
      </svg>
      {% trans "Grid" %}
    </button>
  </form>
</div>
{% endif %}

<div class="mb-4">
  <h3 class="mb-2">{% trans "Edit existing records" %}</h3>
  
  <!-- Standardized filter form -->
  {% include 'butterflies/includes/_filter_form.html' %}
</div>

{% if import_errors %}
<div class="alert alert-danger mb-4 p-3 rounded">
  <h4 class="mt-0 font-bold text-danger">{% trans "Import Errors" %}</h4>
  <p class="text-danger">{% trans "The following errors occurred during import:" %}</p>
  <ul class="mb-0 text-danger">
    {% for error in import_errors %}
      <li>{{ error }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

{% if supports_grid_view and view_mode == 'grid' %}
  {% include "butterflies/_grid.html" with objects=objects %}
{% else %}
  {% include "butterflies/_table.html" with objects=objects fields=fields field_names=field_names request=request %}
{% endif %}

<div class="mt-4 mb-4 d-flex align-items-center">
  <a href="{% url 'dynamic_create' model_name_internal %}" style="background-color: #81b53e; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; display: inline-block;">
    {% trans "Add Single Record" %}
  </a>
  
  {% if user.is_superuser or user|has_group:'Admin' %}
  <div class="ml-4 d-flex align-items-center">
    <a href="{% url 'import_model' model_name_internal %}" style="text-decoration: underline;" class="mr-2">
      {% trans "Import Data" %}
    </a>
    <span class="text-muted font-sm">
      ({% trans "CSV, Excel" %})
    </span>
  </div>
  {% endif %}
</div>
{% endblock %}
