{# Preview template for data import #}
{% load i18n %}
{% load butterfly_extras %}
<h2>{% blocktrans %}Preview {{ model_name_plural }} Import{% endblocktrans %}</h2>

{% if has_unique_field %}
<div style="margin-bottom: 15px;">
    <p>{% trans "Review the data before confirming import." %} <strong>{% trans "Important:" %}</strong></p>
    <ul>
        <li>{% blocktrans %}Duplicate records (with the same "{{ unique_field }}") are highlighted in <span style="background-color: #ffeeee; padding: 2px 5px;">pink</span>.{% endblocktrans %}</li>
        <li>{% blocktrans %}For duplicates, we'll automatically modify the "{{ unique_field }}" by adding a numbered suffix (e.g., "ABC123-2").{% endblocktrans %}</li>
        <li>{% trans "You can edit any values before confirming the import." %}</li>
    </ul>
</div>
{% else %}
<p style="color: #444444;">{% trans "Review the data before confirming import. You can edit any values before confirming." %}</p>
<p style="color: #666666; font-style: italic;">{% trans "Note: No unique field was found for this model, so duplicate detection is not available." %}</p>
{% endif %}

{% if model_name_internal == 'specimen' %}
<div style="margin-bottom: 20px; padding: 10px; border: 1px solid #dddddd; background-color: #f5f5f5; border-radius: 4px;">
    <h4 style="margin-top: 0; color: #555555; font-weight: bold;">{% trans "Important Field Guidelines for Specimens" %}</h4>
    <ul style="margin-bottom: 0; color: #444444;">
        <li><strong>exact_loc</strong>: {% trans "Must be exactly 'TRUE' or 'FALSE' (case-sensitive, no quotes)" %}</li>
        <li><strong>sex</strong>: {% trans "Must be 'male', 'female', or '.' (case-sensitive)" %}</li>
        <li><strong>specimenNumber</strong>: {% trans "Required for catalog number generation" %}</li>
        <li><strong>year</strong>: {% trans "Required for catalog number generation" %}</li>
        <li><strong>locality</strong>: {% trans "Must match an existing locality code" %}</li>
        <li><strong>recordedBy</strong>, <strong>georeferencedBy</strong>, <strong>identifiedBy</strong>: {% trans "Must match existing initials" %}</li>
    </ul>
</div>
{% endif %}

<form method="post">
    {% csrf_token %}
    <input type="hidden" name="confirm" value="true">
    <input type="hidden" name="row_count" value="{{ preview|length }}">
    
    <table border="1" cellpadding="4" cellspacing="0">
        <thead>
            <tr>
                <th>Status</th>
                {% for field in fields %}
                <th>
                    {{ field }}{% if field == unique_field %} <small style="color:#555555; font-style: italic;">(unique key)</small>{% endif %}
                    {% if model_name_internal == 'specimen' %}
                        {% if field == 'exact_loc' %}
                            <br><small style="color:#555555; font-style: italic;">Must be "TRUE" or "FALSE"</small>
                        {% elif field == 'sex' %}
                            <br><small style="color:#555555; font-style: italic;">Must be "male", "female", or "."</small>
                        {% elif field == 'specimenNumber' %}
                            <br><small style="color:#555555; font-style: italic;">Required for catalogNumber</small>
                        {% elif field == 'year' %}
                            <br><small style="color:#555555; font-style: italic;">Required for catalogNumber</small>
                        {% elif field == 'locality' or field == 'recordedBy' or field == 'georeferencedBy' or field == 'identifiedBy' %}
                            <br><small style="color:#555555; font-style: italic;">Must match existing record</small>
                        {% endif %}
                    {% endif %}
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for item in preview %}
            <tr {% if item.duplicate %}style="background-color: #ffeeee;"{% endif %}>
                <td>
                    {% if item.duplicate %}
                    <strong>Duplicate</strong><br>
                    <small>Will use: {{ item.suggested_key }}</small>
                    {% else %}
                    New
                    {% endif %}
                </td>
                {% for field in fields %}
                <td>
                    {% if field == unique_field and item.duplicate %}
                    <input type="text" name="row_{{ forloop.parentloop.counter0 }}_{{ field }}" 
                           value="{{ item.suggested_key|default:'' }}"
                           title="Original value: {{ item.data|get_item:field|default:'' }}">
                    <div style="font-size: 0.8em; color: #666;">Original: {{ item.data|get_item:field|default:'' }}</div>
                    {% else %}
                    <input type="text" name="row_{{ forloop.parentloop.counter0 }}_{{ field }}" 
                           value="{{ item.data|get_item:field|default:'' }}">
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div style="margin-top: 15px;">
        <div>
            <button type="submit">Confirm Import</button>
            <a href="{% url 'import_model' model_name_internal %}" style="margin-left: 10px;">Cancel</a>
        </div>
    </div>
</form>

<div style="margin-top: 20px;">
    <a href="{% url 'dynamic_list' model_name_internal %}">Back to {{ model_name }} List</a>
</div>
